<?php/**//TODOmillores! *  * quan retorna OVER_QUERY_LIMIT  deixar en espera per fer en un altre momentafegir entorn preferent de cerca *  * - &bounds=42.2,1.4|42.4,1.5 *  * - en cas que el valor retornat estigui lluny de la ciutat d'origen, baixar parametre de qualitat? o no admetre * no funciona bé,problemes.. exemplehttp://maps.googleapis.com/maps/api/geocode/json?address=Edificio%20CINC%20C/%20Llull,%20321-329.%2008019%20Barcelona.%20Tel%C3%83%C2%A9fono:%20+34%2093%20303%2000%2060,Spain&sensor=falseno retorna res..treient telefon si.. * http://maps.googleapis.com/maps/api/geocode/json?address=Edificio%20CINC%20C/%20Llull,%20321-329.%2008019%20Barcelona,Spain&sensor=falsei treient edificio cinc molt millorhttp://maps.googleapis.com/maps/api/geocode/json?address=C/%20Llull,%20321-329.%2008019%20Barcelona,Spain&sensor=falsesolucions.. - eliminar el que hi ha abans de c/- etc...*/class GeoCoder extends CComponent{        //bounds a països catalans	static $uri="http://maps.googleapis.com/maps/api/geocode/json?address=*&bounds=38,-1.5|43,5&sensor=false&region=es";                                                //location es l'adreça entregada per que sigui geolocalitzada        //address es l'adreça de cara a l'usuari	public static function encode($location,$address,&$e) {                                      		if($location==""){			return false;		}                   //todo probably do before?              //  $location=utf8_decode(htmlentities ( html_entity_decode($location)) );                                             //mirar si ja existeix                $loc= Location::model()->findByAttributes(array("address"=>$location));                if($loc){                    $e->geo_lat=$loc->lat;                    $e->geo_lng=$loc->lng;                    $e->geo_pre=$loc->pre;                    $e->location_id=$loc->id;                    return $loc;                }                $e->address=$address;                                                		$uri=str_replace("*",urlencode(trim($location)),self::$uri);	                               // print $uri;                		//no funciona la extensió!!! retorna sempre " - "		//$result = Yii::app()->CURL->run("http://www.pimpampum.net");                   //todo fer servir curl general		$result=SimpleCurl::curl_download($uri);                   		if(!$result){			print "error al cridar api google ";                        return false;		}                                                                  		$data=json_decode($result);                               // print_r($data);                		if(isset($data->status)){                    if($data->status=="ZERO_RESULTS"){                        print "error : cap resultat";                            return false;                    }                 		if($data->status=="OVER_QUERY_LIMIT"){			print "error OVER_QUERY_LIMIT";                        usleep(5000);			return false; //TO DO deixar pendent per més endavant		}                   }                //todo verificar que no existeix per no repetir localitzacions                //comprovar amb el nom               /*               $loc = new LocationItem;               $loc->name=$name;               $loc->address=$address;               $loc->lat=$data->results[0]->geometry->location->lat;               $loc->lng=$data->results[0]->geometry->location->lng;               $loc->location_type=$data->results[0]->geometry->location_type;                            $loc->pre=GeoCoder::getPre($loc);                                           $loc->formatted_address=$data->results[0]->formatted_address;               */               //$loc->save();                                                                                       if(isset($data->results)){                    if(count($data->results)>=1){                                                                                              //poblacio                                                if($e->city_id==null){ //sino ha estat assignat abans                        foreach($data->results[0]->address_components as $comp){                                                       if($comp->types[0]=="locality"){                                /*                                * stdClass Object                                (                                    [long_name] => La Vall d'en Bas                                    [short_name] => La Vall d'en Bas                                    [types] => Array                                        (                                            [0] => locality                                            [1] => political                                        )                                )*/                                                                $pob=$comp->long_name;                                print "la city és ".$pob;                                                                $pob_id=EventItem::GetCityId($pob);                                                            $e->city_id=$pob_id;                                                        }                         }                         }                                                        $e->geo_lat=$data->results[0]->geometry->location->lat;                        $e->geo_lng=$data->results[0]->geometry->location->lng;                        $e->geo_pre=GeoCoder::getPre($data->results[0]->geometry->location_type);                        //$e->location_id=$loc->id;                                                                                              //guardar                        $loc=new Location;                        $loc->lat=$e->geo_lat;                        $loc->lng=$e->geo_lng;                        $loc->address=$location;                         $loc->pre=$e->geo_pre;                        $loc->location_type=$data->results[0]->geometry->location_type;                        $loc->save();                        return true;                    }                }                               return false;                                	}        //todo afinar i afegir tots els casos	protected static function getPre($location_type){                                switch($location_type){                   case "APPROXIMATE":                       return 7;                   case "RANGE_INTERPOLATED":                       return 8;                   case "ROOFTOP":                        return 9;               }               return 0;        }	public static function enrich($location,$city,$country) {		$location=strtolower($location);		$res=$location;		if($city!=""){			$city=strtolower($city);			if(!strpos($location,$city)){				$res.=",".$city;			}		}		if($country!=""){			$country=strtolower($country);			if(!strpos($location,$country)){				$res.=",".$country;			}		}		return $res;	}		}