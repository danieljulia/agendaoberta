<?phpclass CronController extends CController {	//parsejar periodicament les fonts    private $analytics;            	public function actionParse($source_id=null,$num=null,$retry=0) {                             $this->analytics=new Analytics(Yii::app()->params['ga_code'],Yii::app()->params['ga_domain']);                            //només actiu a les hores marcades a config                //pero si explicitem el source_id ho fa igualment                if($source_id==null){                    $cron_window=Yii::app()->params['cron_window'];                    if($cron_window){                    if( date('G')<$cron_window[0] || date('G')>$cron_window[1]){                        print "out of window";                         return;                    }                    }                }                                                   Yii::beginProfile('parsing');                   //if source could not finish mark error                $hanged = Source::model()->parsable()->hanged()->findAll();                if(count($hanged)>0){                    $txt="";                    $senderror=false;                    foreach($hanged as $h){                                       $txt.="\r\nSource hanged ".$h->id." errors: ".$h->error." ".$h->name;                                                $retry=Yii::app()->params['error_retry_inverval'];                                                                      $h->error++;                        if( $h->error >= Yii::app()->params['max_errors_per_source']) $senderror=true;                                             $h->updated=new CDbExpression('NOW()');                        //try again until limit                                                if(!$retry) $retry=60*30;                                                        $h->next=new CDbExpression('NOW()+'.$h->error*$retry);                        $h->save();                    }                                                            Yii::log("\r\n\r\n****** ERROR".$txt,"info","ao.parser");                    if($senderror){                    //check if there's email server                        if( $email=Yii::app()->params['parser_email_error']){                            $msg="ao::: error a fonts ".$txt;                            mail($email,"error a paser",$msg);                        }                    }                                    }else{                                                  }                                            if(isset($source_id)){                   $source = Source::model()->findByPk($source_id);                                   }else{                    //find available source                   $source = Source::model()->parsable()->active()->pending()->find();                }                             		print "parsing source ".$source->id." ".$source->name." error:".$source->error." ".$source->getFeed()."next: ".$source->next."\r\n\r\n";                                                Yii::log("\r\n\r\nParsing ".$source->id." ".$source->name);                $source->started=new CDbExpression('NOW()');                $source->updated=0;                 $source->save();                        //todo afegir excepcions per controlar possibles errors                                try{                                                        $parser = $source->getParser();																				if ($parser===null) throw new CException ('Parser not found.');				                                                                                              $items=$parser->parse($num);                                                                                                                                if(!$items){                        throw new CException(Yii::t('yii', 'Error parsing, no items'));                        return false;                    }                                        //convertir items a events de veritat i guardar                     if(!is_array($items)){                        throw new CException(Yii::t('yii', 'Items is not an array'));                         return false;                     }                      if(count($items)==0){                        throw new CException(Yii::t('yii', 'Items empty'));                         if($retry==0){                            print "o items... tornar a provar.. ";                                                        $this->actionParse(null,null,1);                        }                                                return false;                     }                      $new=0;                                                                                                   foreach($items as $item){                                                        //si no està pendent.. de scrapejar a la propera                            if(!$item->pending){                                                            $e=new Event;                            $item->copy($e);                                                               //sino existeix i no es un event del passat                            if( !Event::model()->exists('uid=:uid',array(':uid'=>$e->uid))                                     //|| Event::model()->findByAttributes(array('uid'=>$e->uid))->reflush                                    ){ // && !$item->old                                                                                                                             //$e->reflush=0;                                                                print "<strong>guardant nou event</strong>";                                if(!$e->save(false)){                                    print "error al guardar event";                                }                                //insertar categories després                                $e->saveRelated('categories');                                                                $new++;                                                                $this->analytics->trackEvent("parse","new",$source->id);                                                            }else{                                if($item->old){                                    print "** item is old <br>";                                }else{                                    print "** item already exists <br> ".$e->summary;                                }                               // $this->analytics->trackEvent("parse","already",$source->id);                            }                        }                        }                                        }catch(Exception $e){                    $source->error++;                   // $source->active=0;                    Yii::log("error source desactivada".$e,"info","ao.parser");                    $source->save();                                               $this->analytics->trackEvent("parse","error",$source->id);                                        return false;                }                                                Yii::endProfile('parsing');                Yii::log("Parsed ".$source->feed." ".$source->name."\r\n found new: ".$new." / ".count($items),"info","ao.parser");                                //guardar informació sobre la font i si hi ha hagut errors                //actualitzar dades per la propera vegada                                                 //si funciona bé , baixar nombre errors                $source->error--;                if( $source->error<0)  $source->error=0;                                                  //TODO passar a config                $period_min=120;                $period_step=120;                                if($new==0){                    $source->period+=$period_step;                }else{                    if($source->period>$period_min){                        $source->period-=$period_step;                        if($source->period<$period_min) $source->period=$period_min;                                            }                                   }                $source->new=$new;                $source->updated=new CDbExpression('NOW()');                $source->next=new CDbExpression('NOW()+'.$source->period*60);                                 if(!$source->save()){                                   print_r( $source->getErrors());                 }	}                public function actionPostProcess(){            $this->analytics=new Analytics(Yii::app()->params['ga_code'],Yii::app()->params['ga_domain']);                        //get events                       $events=Event::model()->notProcessed()->findAll(array('limit'=>Yii::app()->params['postprocess_items_per_cron']));               $count=Event::model()->notProcessed()->count();                         if(count($events)==0){                 print "no events to process";                 return;             }                                print "<br><br>**** $count events pending postprocess....<br><br>";                       $categorizer=new Categorizer();                        foreach ($events as $ev){                              $ev->postProcess($categorizer);                                  $this->analytics->trackEvent("parse","postprocess",$ev->id);            }              }                public function actionStats(){               //total events            Stats::superMaps("map");                        //total events            Stats::saveValue("total",Event::model()->count());                                //total 24h            Stats::saveValue("24h",Event::model()->inDays(1,false)->count());                                                         //total 48h            Stats::saveValue("48h",Event::model()->inDays(2,false)->count());                                 //total 24h            Stats::saveValue("7days",Event::model()->inDays(7,false)->count());                     }                                                 public function actionCache2(){             $e=new EventItem("http://www.googldm/blahrteegfe");         print_r($e);                      if($e->cached){                 print_r($e);                              return;             }                       $e->summary="Exemple de tisdasdtol";             $e->startdate="2012-10-20";                 print_r($e);                                        EventItem::setCache($e);                                          }         public function actionCache(){             $e=new EventItem("http://www.google.ecom/blahrt");                          $cache=new CFileCache();                         //$cache->cachePath="c:/temp";                          $res=$cache->get($e->uid);                          print "el valor d'aixo es ";             if($res){                 $e=  unserialize($res);                 print_r($e);                 return;             }                          $e->summary="Exemple de titol";             $e->startdate="2012-10-20";                          $s=serialize($e);                                                       $res=$cache->set($e->uid,$s);                        }                  public function actionLocatePoblacions(){                          $c=0;             $rs = City::model()->ordered()->findAll();               foreach($rs as $p){                   if($p->lat==null){                    print $p->name."<br/>";                                        $e=new EventItem("http");                    GeoCoder::encode($p->name.", Spain",$p->name.", Spain",$e);                    print_r($e);                    $p->lat=$e->geo_lat;                    $p->lng=$e->geo_lng;                    $p->save();                    $c++;                    if($c==20) return;                   }              }          }                                  public function actionTest(){                        /*            //girona.cat            $uri="http://www2.girona.cat//ca/agenda?p_p_id=8&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&_8_struts_action=%2Fcalendar%2Fview_event&_8_eventId=116542&_8_month=5&_8_day=27&_8_year=2012&_8_eventType=";            $uri="http://www2.girona.cat/agenda;jsessionid=41C0DBCD123B4ABD22E20ED560F25330?p_p_id=8&p_p_lifecycle=0&p_p_state=maximized&p_p_mode=view&_8_struts_action=%2Fcalendar%2Fview_event&_8_redirect=http%3A%2F%2Fwww2.girona.cat%2Fagenda%3Bjsessionid%3D41C0DBCD123B4ABD22E20ED560F25330%3Fp_p_id%3D8%26p_p_lifecycle%3D0%26p_p_state%3Dmaximized%26p_p_mode%3Dview%26_8_tabs1%3Dday%26_8_month%3D5%26_8_year%3D2012%26_8_eventType%3D%26_8_day%3D24&_8_eventId=223567&_8_month=5&_8_day=24&_8_year=2012&_8_eventType=";                            $sc=new GironaPageScraper;                        $uri="http://guia.bcn.cat/vetusta-morla_99400288608.html";            $uri="http://guia.bcn.cat/dones-sense-complexos_99400293818.html";                            $sc=new GuiaBcnRssScraper;               */                                         //manresa            $uri="http://www.ajmanresa.cat/web/php/agenda/index.php?cont_ide=actes&festamajor=&acte_id=44793";          $sc=new Scraper;                                        $sc->init($uri);                        $e=new EventItem($uri);                        $sc->scrape($e);                                    print_r($e);                    }                public function actionTest2(){            $str="Silenci d'amor (en català)(Tous les soleils)Comèdia dramàticaFrança – 2011Apta per a tots els públics105 min. Director: Philippe Claudel Intèrprets: Stefano Accorsi, Neri Marcorè, Clotilde Courau, Lisa Cipriani, Anouk Aimée, Marie Seux, Jean-Marie Holterbach, Patricia Joly, Philippe Rebbot i Margot Lefevre Chan. Sinopsi:Alessandro és un professor italià de música barroca que viu a Estrasburg amb Irina, la seva filla de quinze anys que travessa una crisis, i amb el seu germà Crampone, un simpàtic i estrafolari anarquista que no para de demanar asil polític des de que Berlusconi està en el poder. Alessandro, esforçant-se en ser el pare perfecte, s’ha oblidat de reconstruir la seva vida afectiva, sobre tot perquè està rodejat de divertits amics que li impedeixen sentir-se sol. Però quan la seva filla descobreix l’emoció del primer amor, la vida d’Alessandro sofreix un canvi tan inesperat com dramàtic. Abans de projectar la pel·lícula es passarà un espot d’Amnistia InternacionalHORARI22:20 hores.LLOCPlaça del Casal de Cultura.PREUGratuït.Data de modificació: 28/06/2012 10:39:23";                          $sc=new Scraper;              $e=new EventItem("http://www.google.com");              $sc->findLocation($e,$str);                    }        public function actionDelete() {                        Event::model()->deleteAll();            Location::model()->deleteAll();                        $connection=Yii::app()->db;                         $sql="delete from `ao_event_2_category`";            $command=$connection->createCommand($sql);            $command->execute();                                    EventItem::flushCache();        }}